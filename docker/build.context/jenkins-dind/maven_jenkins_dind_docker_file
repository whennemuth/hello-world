FROM ubuntu:14.04

MAINTAINER Decheng Zhang <killercentury@gmail.com>

# Let's start with some basic stuff.
RUN apt-get update -qq && apt-get install -qqy \
    apt-transport-https \
    ca-certificates \
    curl \
    lxc \
    iptables

# Install Docker from Docker Inc. repositories.
RUN curl -sSL https://get.docker.com/ | sh

# Install the wrapper script from https://raw.githubusercontent.com/docker/docker/master/hack/dind.
ADD ./dind /usr/local/bin/dind
RUN chmod +x /usr/local/bin/dind

ADD ./wrapdocker /usr/local/bin/wrapdocker
RUN chmod +x /usr/local/bin/wrapdocker

# Define additional metadata for our image.
VOLUME /var/lib/docker

ENV DOCKER_COMPOSE_VERSION 1.3.3

RUN wget -q -O - https://jenkins-ci.org/debian/jenkins-ci.org.key | apt-key add -
RUN sh -c 'echo deb http://pkg.jenkins-ci.org/debian binary/ > /etc/apt/sources.list.d/jenkins.list'
RUN apt-get update && apt-get install -y zip supervisor jenkins && rm -rf /var/lib/apt/lists/*
RUN usermod -a -G docker jenkins
ENV JENKINS_HOME /var/jenkins_home
VOLUME /var/jenkins_home

# Install Docker Compose
RUN curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose
RUN chmod +x /usr/local/bin/docker-compose

# ADD supervisord.conf /etc/supervisor/conf.d/supervisord.conf

EXPOSE 8080



# Start kuali-jenkins-dind additions...

ARG user=jenkins
ARG group=jenkins
ARG uid=1000
ARG gid=1000

# Copy script that starts jenkins and change jenkins user and group to match those for jenkins on the docker host.
COPY jenkins.sh /usr/local/bin/
RUN \
   chmod ugo+x /usr/local/bin/jenkins.sh && \
   chmod -R ugo+wr /var/log/jenkins && \
   usermod -u ${uid} ${user} && \
   groupmod -g ${gid} ${group}

# `/usr/share/jenkins/ref/` contains all reference configuration we want 
# to set on a fresh new installation. Use it to bundle additional plugins 
# or config file with your custom jenkins Docker image.
RUN mkdir -p /usr/share/jenkins/ref

# Jenkins is run with user `jenkins`, uid = 1000
# If you bind mount a volume from the host or a data container, 
# ensure you use the same uid
# RUN useradd -d "$JENKINS_HOME" -u jenkins -g jenkins -m -s /bin/bash jenkins

ENV JENKINS_UC https://updates.jenkins-ci.org
RUN chown -R ${user} "$JENKINS_HOME" /usr/share/jenkins/ref

EXPOSE 80

# Beef up the memory
ENV JAVA_OPTS="-Xmx8192m"

USER root

# Build maven into the image.
ENV MAVEN_VERSION 3.3.9
RUN mkdir -p /usr/share/maven \
  && curl -fsSL http://apache.osuosl.org/maven/maven-3/$MAVEN_VERSION/binaries/apache-maven-$MAVEN_VERSION-bin.tar.gz \
    | tar -xzC /usr/share/maven --strip-components=1 \
  && ln -s /usr/share/maven/bin/mvn /usr/bin/mvn
ENV MAVEN_HOME /usr/share/maven

# Install nodejs and npm
RUN \
   apt-get update && \
   apt-get install -y nodejs && \
   apt-get install -y npm

# Copy selected system settings files to JENKINS_HOME so they do not have to be set through jenkins admin console.
# Jenkins will transfer these files to JENKINS_HOME, but we cannot transfer them there directly with COPY because
# once a volume has been declared with the VOLUME instruction, you cannot copy anything there.
COPY config.xml /usr/share/jenkins/ref/
COPY hudson.maven.MavenModuleSet.xml /usr/share/jenkins/ref/
COPY credentials.xml /usr/share/jenkins/ref/
COPY hudson.tasks.Maven.xml /usr/share/jenkins/ref/
COPY org.jenkinsci.plugins.docker.commons.tools.DockerTool.xml /usr/share/jenkins/ref/
RUN mkdir -p /usr/share/jenkins/ref/jobs/pull-all-jobs
COPY config-pull-all-jobs.xml /usr/share/jenkins/ref/jobs/pull-all-jobs/config.xml

# Create a directory to mount to later where the .ssh keys will be placed
# and create a directory for the mounted directory contents to be copied to (cannot change permissions of file in mounted directory).
RUN \
   mkdir /var/jenkins_ssh_mount && \
   mkdir /var/jenkins_ssh
COPY ssh_hosts /var/jenkins_ssh
RUN \
   chown -R jenkins:users /var/jenkins_ssh && \
   chmod 766 /var/jenkins_ssh

# Copy in a script that processes the ssh keys and change its properties to be executable.
# NOTE: You cannot put this kind of stuff in /etc/init.d because a docker container is not really a virtual machine and does not have a functioning init system.
# COPY jenkins.sh /usr/local/bin/
# RUN chmod ugo+x /usr/local/bin/jenkins.sh

# Temporarily using an unmounted directory for the jenkins workspaces (builds are having permissions problems on Virtualbox mounted drives)
RUN \
   mkdir -p /var/jenkins_workspace && \
   chmod -R 777 /var/jenkins_workspace

# Turn off hostname hashing so that the host names are human-readable in the known_hosts files
RUN sed -i -- 's/HashKnownHosts yes/HashKnownHosts no/g' /etc/ssh/ssh_config

# Add github.com and any other names to the known_hosts for root so that attempts to make an ssh connection do not result in:
# "host key verification failed" 
RUN mkdir /root/.ssh
# RUN ssh-keyscan -t rsa github.com >> /root/.ssh/known_hosts
COPY ssh_hosts /root/.ssh/
RUN \
   ssh-keyscan -t rsa -f /root/.ssh/ssh_hosts >> /root/.ssh/known_hosts && \
   cp /root/.ssh/ssh_hosts /var/jenkins_ssh

# Overriding the target url for jenkins plugins because of timeout issues probably due to mirroring
# From parent docker file: ENV JENKINS_UC https://updates.jenkins-ci.org
ENV JENKINS_UC_DOWNLOAD https://updates.jenkins.io/download

# Have the plugins.sh script (part of the jenkins image build context) load in jpi files to /usr/share/jenkins/ref/plugins for plugins from a text file listing. 
# Jenkins will install plugins not already there when the container starts.
COPY plugins.sh /usr/local/bin/plugins.sh
COPY plugins.txt /usr/share/jenkins/ref/
RUN \
   chmod -R 755 /usr/local/bin && \
   chmod -R 755 /usr/share/jenkins/ref && \
   /usr/local/bin/plugins.sh /usr/share/jenkins/ref/plugins.txt

# Have the jenkins logs written out to a mounted volume
# Include the mount target directory when starting the container with a "-v" arg.
RUN \
   mkdir -p /var/log/jenkins && \
   chown -R  jenkins:jenkins /var/log/jenkins && \
   chmod -R a+rw /var/log
VOLUME /var/log/jenkins
ENV JENKINS_OPTS="--prefix=/jenkinsdind --logfile=/var/log/jenkins/jenkins.log"
# If not mounting a volume, you can still check the log from outside the container as follows:
# exec jenkins-master tail -f /var/log/jenkins/jenkins.log

ADD supervisord.conf /etc/supervisor/conf.d/supervisord.conf

CMD ["/usr/bin/supervisord"]

USER jenkins